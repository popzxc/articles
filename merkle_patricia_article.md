_"Какого дьявола я должен помнить наизусть все эти чёртовы алгоритмы и структуры данных?"._

Примерно к этому сводятся комментарии большинства статей про прохождение технических интервью. Основной тезис, как правило, заключается в том, что всё так или иначе используемое уже реализовано по десять раз и с наибольшей долей вероятности заниматься этим рядовому программисту вряд ли придётся. Что ж, в какой-то мере это верно. Но, как оказалось, реализовано не всё, и мне, к сожалению (или к счастью?) реализовывать Структуру Данных всё-таки пришлось. Загадочное Modified Merkle Patricia Trie. Так как на хабре информации об этом дереве нет вообще, а на медиуме -- немногим больше, хочу поведать о том, что же это за зверь, и с чем его едят.

[КПДВ]

Для начала, давайте разберемся, что это за структура и зачем она вообще нужна. Делать мы будем это по частям.

<cut />

## Что это?

_Дерево_ - структура данных, представляющая собой связный ациклический граф. Тут всё просто, все с этим знакомы.

_Префиксное дерево_ - корневое дерево, в котором можно хранить пары ключ-значение за счёт того, что узлы делятся на два типа: те, что содержат часть пути (префикс), и конечные узлы, которые содержат хранимое значение. Таким образом получается, что значение присутствует в дереве тогда и только тогда, когда мы, используя ключ, можем пройти от корня дерева весь путь и в конце найти узел со значением.

_PATRICIA-дерево_ - это префиксное дерево, в котором префиксы бинарны - то есть, каждый узел-ключ хранит информацию об одном бите.

_Дерево Мёркла_ - это дерево хешей, построенное над какой-то цепочкой данных, агрегирующее эти самые хеши в один (корневой), хранящий информацию о состоянии всех блоков данных. То есть, корневой хеш - это эдакая "цифровая подпись" состояния цепи блоков. Используется эта штука активно в блокчейне, и подробнее про неё можно почитать [тут](https://habr.com/ru/company/bitfury/blog/346398/).

[картинка-демонстрация всех 4 деревьев]

Таким образом можно понять, что Modified Merkle Patricia Trie (далее MPT для краткости) - это дерево хешей, хранящее пары ключ-значение, при этом ключи представлены в бинарном виде. А в чем именно заключается "Modified" мы узнаем чуть позже, когда будем обсуждать реализацию.

## Зачем это?

MPT используется в проекте Ethereum для хранения данных об аккаунтах, транзакциях, результатах их выполнения и прочих данных, необходимых для функционирования системы.
В отличие от Bitcoin, в котором состояние неявно и вычисляется каждым узлом самостоятельно, в эфире баланс каждого аккаунта (а также ассоциированные с ним данные) хранятся непосредственно в блокчейне. Более того, нахождение и неизменность данных должны быть обеспечены криптографически -- мало кто станет пользоваться криптовалютой, в которой баланс случайного аккаунта может измениться без объективных на то причин. 

*TODO*


## Как это?

Со вступлением покончено, переходим к реализации. Использовать будем лингва франка от мира IT, то бишь `python`.

Для начала определим интерфейс дерева, который мы хотим получить в итоге:

```python
class MerklePatriciaTrie:
    def __init__(self, storage, root=None):
        pass

    def root(self):
        pass

    def get(self, encoded_key):
        pass

    def update(self, encoded_key, encoded_value):
        pass

    def delete(self, encoded_key):
        pass
```

Интерфейс предельно прост. Доступные операции - получение, удаление, вставка и измененение (объединенные в update), а также получение корневого хеша.

В метод `__init__` будет передаваться хранилище - `dict`-like структура данных, в которой мы будем хранить узлы, а также `root` - "вершина" дерева. В случае, если в качестве `root` передан `None` - считаем, что дерево пустое и работаем с нуля.

_Ремарка: возможно, вам интересно, почему переменные в методах названы как `encoded_key` и `encoded_value`, а не просто `key`/`value`. Ответ прост: по спецификации все ключи и значения должны быть закодированы в `rlp`. Мы же этим себя утруждать не будем и оставим сие занятие на плечи пользователей библиотеки._


